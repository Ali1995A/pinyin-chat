  <script>
    const $ = (id) => document.getElementById(id);

    const state = {
      lastReplyText: "",
      lastPinyinLines: [],
      lastHanziLines: [],
    };

    function showError(message) {
      const el = $("err");
      if (!message) {
        el.style.display = "none";
        el.textContent = "";
        return;
      }
      el.style.display = "block";
      el.textContent = message;
    }

    function normalizePinyin(input) {
      if (!input) return "";
      // 1) NFD: 把预合成的 ā/á/ǎ/à 等拆成 base + combining mark。
      // 2) a -> ɑ：确保你指定的 a 字形按 IPA 开口 a 渲染。
      return input.normalize("NFD").replace(/a/g, "ɑ");
    }

    function isHanChar(ch) {
      return /\p{Script=Han}/u.test(ch);
    }

    function toPinyinForChar(ch) {
      if (!isHanChar(ch)) return "";
      const arr = window.pinyinPro.pinyin(ch, { toneType: "symbol", type: "array" });
      const py = (arr && arr[0]) ? arr[0] : "";
      return normalizePinyin(py);
    }

    function renderAlignedText(text) {
      const out = $("output");
      out.textContent = "";

      const lines = String(text || "").split(/\r?\n/);
      state.lastPinyinLines = [];
      state.lastHanziLines = [];

      for (const lineText of lines) {
        const lineEl = document.createElement("div");
        lineEl.className = "line";

        const hanziChars = Array.from(lineText);
        const pinyinSyllables = [];

        for (const ch of hanziChars) {
          const cell = document.createElement("span");
          cell.className = "cell";

          const py = toPinyinForChar(ch);
          pinyinSyllables.push(py);

          const pyEl = document.createElement("span");
          pyEl.className = "pinyin-text";
          pyEl.textContent = py || "\u00A0";

          const hzEl = document.createElement("span");
          hzEl.className = "hanzi-text";
          hzEl.textContent = ch;

          cell.appendChild(pyEl);
          cell.appendChild(hzEl);
          lineEl.appendChild(cell);
        }

        out.appendChild(lineEl);
        state.lastPinyinLines.push(pinyinSyllables.join(" ").trimEnd());
        state.lastHanziLines.push(hanziChars.join(""));
      }
    }

    function buildPrompt({ childName, childAge, childTraits, childMessage }) {
      const namePart = childName ? `孩子名字：${childName}` : "孩子名字：未提供";
      const agePart = childAge ? `孩子年龄：${childAge}` : "孩子年龄：未提供";
      const traitPart = childTraits ? `孩子性格/近况：${childTraits}` : "孩子性格/近况：未提供";
      const msgPart = childMessage ? `孩子的话：${childMessage}` : "孩子的话：未提供";

      return [
        {
          role: "system",
          content: [
            "你是一位温柔、坚定、会倾听的父亲。",
            "请用简体中文回复孩子，语气要安全、鼓励、具体，避免说教和抽象大道理。",
            "不要使用表情符号，不要输出拼音，不要输出英文。",
            "输出2-6段短句，每段不超过20字。"
          ].join("\n"),
        },
        {
          role: "user",
          content: [
            namePart,
            agePart,
            traitPart,
            msgPart,
            "请以爸爸视角给孩子回复。"
          ].join("\n"),
        }
      ];
    }

    function localFallbackReply({ childName, childAge, childTraits, childMessage }) {
      const name = childName || "宝贝";
      const age = childAge ? `${childAge}岁` : "";
      const traits = childTraits ? `我知道你最近${childTraits}。` : "";
      const msg = childMessage ? `你刚才说：${childMessage}` : "";
      return [
        `${name}${age}，爸爸在。`,
        msg,
        traits,
        "先深呼吸三次。",
        "把发生的事慢慢讲给爸爸听。",
        "爸爸会和你一起想办法。"
      ].filter(Boolean).join("\n");
    }

    async function callChatCompletions({ endpoint, apiKey, model, temperature, maxTokens, messages }) {
      const body = { model, messages, temperature };
      if (maxTokens) body.max_tokens = maxTokens;

      const res = await fetch("/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });

      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data?.error || `HTTP ${res.status}`);
      if (!data?.content) throw new Error("本地代理未返回 content");
      return String(data.content).trim();
    }

    function setLoading(isLoading) {
      $("btnGenerate").disabled = isLoading;
      $("btnGenerate").textContent = isLoading ? "生成中…" : "生成爸爸回复";
    }

    async function onGenerate() {
      showError("");

      const childName = $("childName").value.trim();
      const childAge = $("childAge").value.trim();
      const childTraits = $("childTraits").value.trim();
      const childMessage = $("childMessage").value.trim();

      if (!childMessage && !childTraits && !childName) {
        showError("至少填写：孩子对爸爸说的话（或补充一些孩子信息）。");
        return;
      }

      const endpoint = $("endpoint").value.trim();
      const model = $("model").value.trim();
      const temperature = Number($("temperature").value);
      const maxTokens = Number($("maxTokens").value.trim() || "0") || undefined;

      setLoading(true);
      try {
        let reply;
        const startedAt = performance.now();

        const hasLocalServer = window.__CONFIG__?.mode === "proxy" && Boolean(model);

        if (!hasLocalServer) {
          reply = localFallbackReply({ childName, childAge, childTraits, childMessage });
          $("meta").textContent = "本地示例回复（未连接本地服务）";
        } else {
          const messages = buildPrompt({ childName, childAge, childTraits, childMessage });
          reply = await callChatCompletions({ endpoint, apiKey: "", model, temperature, maxTokens, messages });
          const ms = Math.round(performance.now() - startedAt);
          $("meta").textContent = `AI 已生成（${ms} ms）`;
        }

        state.lastReplyText = reply;
        renderAlignedText(reply);
      } catch (e) {
        showError(String(e?.message || e));
        $("meta").textContent = "生成失败";
      } finally {
        setLoading(false);
      }
    }

    async function onCopy() {
      if (!state.lastReplyText) return;
      const blocks = [];
      for (let i = 0; i < state.lastHanziLines.length; i++) {
        blocks.push(state.lastPinyinLines[i] || "");
        blocks.push(state.lastHanziLines[i] || "");
      }
      const text = blocks.join("\n");
      await navigator.clipboard.writeText(text);
      $("meta").textContent = "已复制到剪贴板";
      setTimeout(() => {
        if (state.lastReplyText) $("meta").textContent = "已生成";
      }, 1200);
    }

    function onClear() {
      showError("");
      $("childName").value = "";
      $("childAge").value = "";
      $("childTraits").value = "";
      $("childMessage").value = "";
      $("output").textContent = "";
      $("meta").textContent = "等待生成…";
      state.lastReplyText = "";
      state.lastPinyinLines = [];
      state.lastHanziLines = [];
    }

    $("btnGenerate").addEventListener("click", onGenerate);
    $("btnCopy").addEventListener("click", onCopy);
    $("btnClear").addEventListener("click", onClear);

    async function bootstrapConfig() {
      try {
        const res = await fetch("/api/config", { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const cfg = await res.json();
        window.__CONFIG__ = cfg;
        $("endpoint").value = cfg?.url || "（未提供）";
        $("model").value = cfg?.model || "（未提供）";
        $("meta").textContent = "已连接本地服务（.env）";
      } catch {
        window.__CONFIG__ = null;
        $("endpoint").value = "（未连接本地服务）";
        $("model").value = "（未连接本地服务）";
      }
    }

    // 初始化：展示一行验收样例，确认 a -> ɑ 的字形。
    const sample = "验收：ā á ǎ à  a";
    const samplePinyin = normalizePinyin(sample);
    renderAlignedText("爸爸在。\n" + "（打开开发者工具也可以）");
    console.log("Pinyin normalization sample:", samplePinyin);
    bootstrapConfig();
  </script>

